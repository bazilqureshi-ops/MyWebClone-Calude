@using Emse.QMagic.Web.Models;
@{
    Layout = null;

    string Name = "";
    bool AskPin = true;
    qmUser User = new qmUser();
    if (ViewBag.Name != null)
    {
        Name = ViewBag.Name;
        AskPin = ViewBag.AskPin;
        User = ViewBag.User;
    }
}
<!DOCTYPE html>
<html>
<head>
    <title>Login - QMagic Management Studio</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" type="text/css" href="~/assets/css/vendor.css">
    <link rel="stylesheet" type="text/css" href="~/assets/css/flat-admin.css">
    <link rel="icon" href="~/assets/qmagic.ico">
    <link rel="stylesheet" type="text/css" href="~/assets/css/hand-terminal.css" />
    <script language="javascript" type="text/javascript" src="~/assets/js/jquery.js"></script>

    <script>
        $(document).ready(function () {

        });
        function StartLoading() {
            $(".loader-container").show();
            $("#form1").submit();
        }

        if (window.outerWidth <= 1300) {
            document.addEventListener('contextmenu', event => event.preventDefault());
        }
    </script>

    <style>
        .shadow {
            -moz-box-shadow: inset 0 0 20px #000000;
            -webkit-box-shadow: inset 0 0 20px #000000;
            box-shadow: inset 0 0 20px #000000;
        }
    </style>

</head>
<body style="overflow:hidden;">

    <div style="background-image:url(assets/images/pattern1.png); background-size:cover; width:100%; height:100%; position:absolute; z-index:1;"></div>

    <img src="~/assets/images/qlogo.png" style="position:absolute; left:-30px; bottom:-30px; z-index:2;" />

    <label style="position:absolute; right:5px; bottom:5px; z-index:2; font-family:'Segoe UI'; font-size:16px; font-weight:bold; color:#ffffff;">@(System.Environment.MachineName) - v1.4.81</label>


    <div class="app app-default">
        <div class="app-container app-login shadow">
            <div class="flex-center" style="position:relative; z-index:3;">
                <div class="app-header"></div>
                <div class="app-body">
                    <div class="loader-container text-center" style="position:absolute; z-index:8; background-color:#FFF; width:100%; margin-top:140px;">
                        <div class="icon">
                            <div class="sk-folding-cube">
                                <div class="sk-cube1 sk-cube"></div>
                                <div class="sk-cube2 sk-cube"></div>
                                <div class="sk-cube4 sk-cube"></div>
                                <div class="sk-cube3 sk-cube"></div>
                            </div>
                        </div>
                        <div class="title">Logging in...<p>&nbsp;</p><p>&nbsp;</p><p>&nbsp;</p><p>&nbsp;</p><p>&nbsp;</p></div>
                    </div>
                    <div class="app-block">
                        <div class="app-form">
                            <div class="form-header">
                                <div class="app-brand"><img src="~/assets/images/qmagic.png" height="120" /></div>
                            </div>
                            @{
                                if (Request.QueryString["err"] != null)
                                {
                                    string err = Request.QueryString["err"];
                                    if (err == "1")
                                    {
                                        <p style="color:#C00;">Username or password incorrect.</p>
                                    }

                                    if (err == "2")
                                    {
                                        <p style="color:#C00;">Your session timed-out.</p>
                                    }

                                    if (err == "3")
                                    {
                                        <p style="color:#C00;">This user has been deleted from system</p>
                                    }

                                    if (err == "4")
                                    {
                                        <p style="color:#C00;">
                                            Unable to connect to the distribution server. Session has been timed-out.(0x145300)
                                        </p>
                                    }

                                    if (err == "5")
                                    {
                                        <p style="color:#C00;">
                                            Database is not like expected. Last sync operation may be failed. (0x965485)
                                        </p>
                                    }

                                    if (err == "6")
                                    {
                                        <p style="color:#C00;">
                                            No license found. Please enter a valid license key to continue. (0x158741)
                                        </p>
                                    }
                                }
                            }
                            <form action="@Url.Action("Login", "Session")" method="post" name="form1" id="form1">

                                @{
                                    if (Name != "")
                                    {
                                        if (User != null)
                                        {
                                            if (AskPin)
                                            {
                                                <center><img src="@(User.ProfilePicture)" style="width:100px; height:100px; border-radius:50px; border:solid 2px #000;" /></center>
                                                <center><h3>@(User.FullName)</h3></center>
                                                <center><h5>Welcome back!</h5></center>
                                                <p>Please enter your pin for login to the system.</p>
                                                <div class="input-group">
                                                    <span class="input-group-addon" id="basic-addon1">
                                                        <i class="fa fa-lock" aria-hidden="true"></i>
                                                    </span>
                                                    <input type="text" class="form-control" placeholder="Username" name="Username" aria-describedby="basic-addon1" value="@(Name)" style="display:none;" />
                                                    <input type="password" class="form-control" placeholder="PIN" name="password" aria-describedby="basic-addon1" />
                                                </div>
                                                <div class="text-center">
                                                    <button type="submit" class="btn btn-success btn-submit" onclick="StartLoading();">Login</button>
                                                </div>

                                                <script>
                                                    $(document).ready(function () {
                                                        $(".form-header").slideUp(3000);
                                                    });
                                                </script>
                                            }
                                            else
                                            {
                                                <input type="text" class="form-control" placeholder="Username" name="Username" aria-describedby="basic-addon1" value="@(Name)" style="display:none;" />
                                                <input type="password" class="form-control" placeholder="Password" name="Password" aria-describedby="basic-addon2" value="@(User.Password)" style="display:none;" />
                                                <script>
                                                    var theurl = $("#form1").attr("action");
                                                    $("#form1").attr("action", theurl + "/?IsHashed=True");
                                                    StartLoading();
                                                </script>
                                            }
                                        }
                                        else
                                        {
                                            <div class="input-group">
                                                <span class="input-group-addon" id="basic-addon1">
                                                    <i class="fa fa-user" aria-hidden="true"></i>
                                                </span>
                                                <input type="text" class="form-control" placeholder="Username" name="Username" aria-describedby="basic-addon1" value="@(Name)" />
                                            </div>
                                            <div class="input-group">
                                                <span class="input-group-addon" id="basic-addon2">
                                                    <i class="fa fa-key" aria-hidden="true"></i>
                                                </span>
                                                <input type="password" class="form-control" placeholder="Password" name="Password" aria-describedby="basic-addon2" />
                                            </div>
                                            <div class="text-left">
                                                <label><input type="checkbox" name="chkRemember" id="chkRemember" class="checkbox-inline" /> Remember Me</label><br /><br />
                                            </div>
                                            <p>You're in active directory but your credentials could not be found in the QMagic system. Please login with another user or contact with your IT department.</p>
                                            <div class="text-center">
                                                <button type="submit" class="btn btn-success btn-submit" onclick="StartLoading();">Login</button>
                                            </div>
                                        }
                                    }
                                    else
                                    {
                                        <div class="input-group">
                                            <span class="input-group-addon" id="basic-addon1">
                                                <i class="fa fa-user" aria-hidden="true"></i>
                                            </span>
                                            <input type="text" class="form-control" placeholder="Username" name="Username" aria-describedby="basic-addon1" value="@(Name)" />
                                        </div>
                                        <div class="input-group">
                                            <span class="input-group-addon" id="basic-addon2">
                                                <i class="fa fa-key" aria-hidden="true"></i>
                                            </span>
                                            <input type="password" class="form-control" placeholder="Password" name="Password" aria-describedby="basic-addon2" />
                                        </div>
                                        <div class="text-left">
                                            <label><input type="checkbox" name="chkRemember" id="chkRemember" class="checkbox-inline" /> Remember Me</label><br /><br />
                                        </div>
                                        <div class="text-center">
                                            <button type="submit" class="btn btn-success btn-submit" onclick="StartLoading();">Login</button>
                                        </div>
                                    }
                                }
                            </form>


                            <style>
                                #ac {
                                    position: absolute;
                                    float: right;
                                    right: 0;
                                    top: 5px;
                                    height: 47.8%;
                                    border-radius: 5px;
                                    line-height: 4.5;
                                }

                                #backspace {
                                    position: absolute;
                                    float: right;
                                    right: 0;
                                    top: 50.8%;
                                    line-height: 4.5;
                                    height: 48.3%;
                                    border-radius: 5px;
                                }

                                .key {
                                    display: inline-block;
                                    margin: 0 5px 5px 0;
                                    border: 1px solid #999;
                                    padding: 20px;
                                    width: 72px;
                                }

                                .keyboard {
                                    display: none;
                                    position: absolute;
                                    top: 42%;
                                    background-color: white;
                                    z-index: 999;
                                    right: -64.5%;
                                    width: 420px;
                                    height: auto;
                                    padding-left: 20px;
                                    padding-top: 5px;
                                }

                                .key {
                                    display: inline-block;
                                    margin: 0 5px 5px 0;
                                    border: 1px solid #999;
                                    padding: 28px;
                                    width: 96px;
                                    height: 96px;
                                    text-align: center;
                                    font-size: 24px;
                                    line-height: 1.8;
                                    border-radius: 10%;
                                    background-color: #29c75f;
                                    color: white;
                                }
                            </style>

                            <div class="keyboard">
                                <div class="row">
                                    <div class="key" key="1">1</div>
                                    <div class="key" key="2">2</div>
                                    <div class="key" key="3">3</div>
                                </div>
                                <div class="row">
                                    <div class="key" key="4">4</div>
                                    <div class="key" key="5">5</div>
                                    <div class="key" key="6">6</div>
                                </div>
                                <div class="row">
                                    <div class="key" key="7">7</div>
                                    <div class="key" key="8">8</div>
                                    <div class="key" key="9">9</div>
                                </div>
                                <div class="row">
                                    <div class="key" key="<"><</div>
                                    <div class="key" key="0">0</div>
                                    <div class="key" key=">">></div>
                                </div><div class="row">
                                    <div id="ac" class="key" key="delete"><i class="fa fa-arrow-left" key="delete"></i></div>
                                    <div id="backspace" class="key" key="ac">AC</div>
                                </div>

                            </div>
                        </div>
                    </div>
                </div>
                <div class="app-footer">
                </div>
            </div>
        </div>
    </div>

    <script type="text/javascript" src="~/assets/js/vendor.js"></script>
    <script type="text/javascript" src="~/assets/js/app.js"></script>
    <script>
        let currentElement = null,
            activated = false;

        $(document).ready(() => {

            $('.key').on('mousedown',
                function (event) {
                    event.preventDefault();
                }
            );

            $(document).click(function (e) {

                if (e.target.tagName === 'INPUT' && e.target.attributes.class.value.includes('form-control') && window.outerHeight <= 840 && window.outerWidth <= 1300) {
                    currentElement = e.target;

                    $('.input-group').css({
                        'border': '',
                        'border-color': ''
                    });

                    $(currentElement.parentElement).css({
                        'border': '2px solid',
                        'border-color': '#29c75f'
                    });

                    if (!activated) {
                        activated = true;

                        $('.app-block').animate({ left: '-20%' }, 100, () => {
                            $('.keyboard').fadeIn(150);
                        });




                    }
                    //$('.app-block').css('left', '-20%');
                }
                else if (e.target.attributes.class === undefined) {
                    currentElement = null;

                    $('.input-group').css({
                        'border': '',
                        'border-color': ''
                    });

                    if (activated) {
                        $('.keyboard').fadeOut(150);
                        $('.app-block').animate({ left: '0' }, 100, () => {
                            $('.keyboard').fadeOut(150);
                            activated = false;

                        });
                    }


                }
                else if (!e.target.tagName !== 'INPUT' && !e.target.attributes.class.value.includes('key') | !e.target.tagName === 'INPUT' && !e.target.attributes.class.value.includes('row') | !e.target.tagName === 'INPUT' && !e.target.attributes.class.value.includes('keyboard') | !e.target.attributes.class.value.includes('fa')) {
                    currentElement = null;

                    $('.input-group').css({
                        'border': '',
                        'border-color': ''
                    });

                    if (activated) {
                        $('.keyboard').fadeOut(150);
                        $('.app-block').animate({ left: '0' }, 100, () => {
                            $('.keyboard').fadeOut(150);
                            activated = false;

                        });
                    }

                    $('.input-group').css({
                        'border': '',
                        'border-color': ''
                    });

                    if (activated) {
                        $('.keyboard').fadeOut(150);
                        $('.app-block').animate({ left: '0' }, 100, () => {
                            $('.keyboard').fadeOut(150);
                            activated = false;

                        });
                    }

                }

                if (e.target.attributes.class != undefined && e.target.attributes.class.value.includes('key') || e.target.nodeName === "I" && e.target.attributes.class != undefined && e.target.attributes.class.value.includes('fa-arrow-left')) {

                    let key = e.target.attributes.key.value,
                        newValue = '',
                        curserIndex = 0;

                    switch (key) {
                        case "0":
                        case "1":
                        case "2":
                        case "3":
                        case "4":
                        case "5":
                        case "6":
                        case "7":
                        case "8":
                        case "9":
                            //Converting value string to array. We'll work on new array.
                            newValue = currentElement.value.split('');

                            //Getting current curser index.
                            curserIndex = currentElement.selectionStart;

                            //Add element to index number 'n' in array
                            newValue.splice(curserIndex, 0, e.target.attributes.key.value);

                            //Then convert 'array' to 'string'
                            currentElement.value = newValue.join('');

                            //Updating our element selection start and end point.
                            currentElement.selectionStart = curserIndex + 1;
                            currentElement.selectionEnd = curserIndex + 1;

                            break;
                        case 'delete':
                            //Converting value string to array. We'll work on new array.
                            newValue = currentElement.value.split('');

                            //Getting current curser index.
                            curserIndex = currentElement.selectionStart;

                            //Delete element from index number 'n' in array.
                            newValue.splice(curserIndex - 1, 1);

                            //Then convert 'array' to 'string'
                            newValue = newValue.join('');

                            //Changing current element value with our processed value;
                            currentElement.value = newValue;

                            //Updating our element selection start and end point.
                            currentElement.selectionStart = curserIndex - 1;
                            currentElement.selectionEnd = curserIndex - 1;
                            break;
                        case 'ac':
                            //Set value of element empty
                            currentElement.value = '';

                            break;
                        case '<':

                            curserIndex = currentElement.selectionStart;

                            if (curserIndex === 0)
                                break;

                            currentElement.selectionStart = curserIndex - 1;
                            currentElement.selectionEnd = curserIndex - 1;

                            break;

                        case '>':
                            curserIndex = currentElement.selectionStart;

                            if (curserIndex === currentElement.value.length)
                                break;

                            currentElement.selectionStart = curserIndex + 1;
                            currentElement.selectionEnd = curserIndex + 1;

                            break;
                        default:
                        // code block
                    }
                }
            });
        });

    </script>
</body>
</html>