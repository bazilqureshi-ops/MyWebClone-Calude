@using Emse.QMagic.Web.Models;
@{
    ViewBag.Title = "Edit Rule";
    Layout = "~/Views/Shared/_Layout.cshtml";

    qmGenerateTicketRule rule = ViewBag.rule;
    List<qmGenerateTicketItem> items = ViewBag.items;
    List<qmService> services = ViewBag.services;
    List<qmSegment> segments = ViewBag.segments;
}

<link href="~/assets/css/sweetalert2.min.css" rel="stylesheet" />
<script src="~/assets/js/sweetalert2.all.min.js"></script>

<script>
    var RuleID = @(rule.GenerateTicketRuleID);

    function AddRule() {
        var SegmentID = $("#cmbSegment").val();

        if (SegmentID != null && SegmentID != "") {
            $.post("AddRule", { SegmentID: SegmentID, RuleID: RuleID }, function (data) {
                if (data.includes("OK++")) {
                    swal({
                        title: "Rule Created!",
                        icon: "success"
                    });
                }
            });
        }
    }

    function AddRule() {
        var SegmentID = $("#cmbSegment").val();

        if (SegmentID != null && SegmentID != "") {
            $.post("AddRule", { SegmentID: SegmentID, RuleID: RuleID }, function (data) {
                if (data.includes("OK++")) {
                    swal({
                        title: "Rule Created!",
                        icon: "success"
                    }).then((wo) => {
                        location.reload();
                    });
                }
            });
        }
    }

    function AddHeader() {
        var HeaderText = $("#txtHeader").val();

        if (HeaderText != null && HeaderText != "") {
            $.post("AddHeader", { HeaderText: HeaderText, RuleID: RuleID }, function (data) {
                if (data.includes("OK++")) {
                    swal({
                        title: "Header Created!",
                        icon: "success"
                    }).then((wo) => {
                        location.reload();
                    });
                }
            });
        }
    }

    function RemoveRuleItem(RuleID) {
        swal({
            title: "Are you sure want to delete this record?",
            text: "If you delete this record all the data generated from that record also will be deleted. Do you want to proceed?",
            icon: "warning",
            buttons: true,
            dangerMode: true,
        })
            .then((willDelete) => {
                if (willDelete) {
                    $.get("../GenerateTicket/RemoveRuleItem", { RuleID: RuleID }, function (data) {
                        if (data.includes("OK++")) {
                            swal({
                                title: "Rule Removed!",
                                icon: "success"
                            }).then((wo) => {
                                location.reload();
                            });
                        }
                    });
                } else {
                    swal({
                        title: "Nothing changed",
                        icon: "success"
                    });
                }
            });
    }

    function SwitchToggle() {
        if ($("#chkHeader").is(":checked")) {
            $("#HeaderDiv").show();
            $("#ServiceDiv").hide();
        }
        else {
            $("#HeaderDiv").hide();
            $("#ServiceDiv").show();
        }
    }
</script>

<style>
    .selected {
        background-color: #666;
        color: #fff;
    }
</style>

<div class="row">
    <div class="col-xs-6 col-xs-offset-3">
        <div class="card">
            <div class="card-header">
                Edit Rule
            </div>
            <div class="card-body no-padding">
                <table class="datatable table table-striped primary" cellspacing="0" width="100%" id="GenerateTable">
                    <thead>
                        <tr>
                            <td width="30">#</td>
                            <td align="left" class="text-left">Text</td>
                            <td width="50">Delete</td>
                        </tr>
                    </thead>
                    <tbody>
                        @{
                            foreach (qmGenerateTicketItem ruleitem in items)
                            {
                                <tr id="ruleitem_@(ruleitem.GenerateTicketItemID)">
                                    <td>
                                        @(ruleitem.OrderNumber)
                                    </td>
                                    <td align="left" class="text-left">
                                        @{
                                            if (ruleitem.IsHeader)
                                            {
                                                <b>@Html.Raw(ruleitem.HeaderText)</b>
                                            }
                                            else
                                            {
                                                qmSegment segment = segments.Where(x => x.SegmentID == ruleitem.SegmentID).FirstOrDefault();
                                                <label style="font-weight:normal;">
                                                    @(services.Where(x=>x.ServiceID == segment.ServiceID).FirstOrDefault().ServiceName) / 
                                                    @(segment.SegmentName)
                                                </label>
                                            }
                                        }
                                    </td>
                                    <td width="30"><a href="#" class="btn btn-danger" onclick="RemoveRuleItem(@(ruleitem.GenerateTicketItemID));"><i class="fa fa-remove"></i></a></td>
                                </tr>
                            }
                        }
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <div class="col-xs-10 col-xs-offset-1">
        <div class="card">
            <div class="card-body">
                <div class="row">
                    <div class="col-md-2">
                        <center><label style="margin-top:15px; align-content:center;"><input type="checkbox" class="form-check-input" name="chkHeader" id="chkHeader" onclick="SwitchToggle();" /> Is Header</label></center>
                    </div>
                    <div class="col-md-10" id="HeaderDiv" style="display:none;">
                        <div class="col-md-9">
                            <input type="text" name="txtHeader" id="txtHeader" class="form-control" />
                        </div>
                        <div class="col-md-3">
                            <button class="btn btn-primary" onclick="AddHeader();"><i class="fa fa-plus"></i></button>
                        </div>
                    </div>
                    <div class="col-md-10" id="ServiceDiv">
                        <div class="col-md-9">
                            <select name="cmbSegment" id="cmbSegment" class="select2">
                                @{
                                    foreach (qmSegment segment in segments)
                                    {
                                        <option value="@(segment.SegmentID)">@(services.Where(x=>x.ServiceID == segment.ServiceID).FirstOrDefault().ServiceName) / @(segment.SegmentName)</option>
                                    }
                                }
                            </select>
                        </div>
                        <div class="col-md-3">
                            <button class="btn btn-primary" onclick="AddRule();"><i class="fa fa-plus"></i></button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script type="text/javascript">
    $(function () {
        $("#GenerateTable").sortable({
            items: 'tr',
            cursor: 'pointer',
            axis: 'y',
            dropOnEmpty: false,
            start: function (e, ui) {
                ui.item.addClass("selected");
            },
            stop: function (e, ui) {
                ui.item.removeClass("selected");
                $('#GenerateTable>tbody>tr').each(function (index, tr) {
                    var ruleitemid = tr.getAttribute("id");
                    ruleitemid = ruleitemid.replace("ruleitem_", "");

                    $.post("ChangeItemOrder", { RuleItemID: ruleitemid, OrderNumber: index }, function (data) {
                        if (data.includes("OK++")) {
                            $(tr).find("td:eq(0)").html(index);
                        }
                    });
                });
            }
        });
    });
</script>